<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <title>お年寄りサービス</title>

</head>
<body>
    <div class="container">
        <h1>お困りですか？</h1>
        <p>聞きたいことや、お願いしたいことを話すか、文字で入力してください。</p>

        <div class="request">
            <h2>依頼をする</h2>
            <div class="button">
                <button class="mic" id="start-button">
                    <img src="icon.png" alt="マイクのアイコン" width="24">
                </button>
                <input type="text" id="request-input" class="input-text" placeholder="例：電球を変えてほしい" />
                <select id="family-select" class="select"></select>
                <button class="submit" id="request-button">依頼する</button>
            </div>
            <div>マイクのボタンを押すか、文字を入力してください</div>
        </div>

        <div class="status-section">
            <h2>依頼状況の確認</h2>
            <ul class="status-list" id="request-list">
                </ul>
        </div>
        
        <div class="family-section">
            <h2>家族</h2>
            <ul class="family" id="family-list">
                </ul>
            <a href="family.html">新しい家族を登録する</a>
        </div>

    </div>

     <script>
        const startButton = document.getElementById('start-button');
        const requestInput = document.getElementById('request-input');
        const submitRequestButton = document.getElementById('request-button');
        const requestStatusDisplay = document.getElementById('request-status-display');
        const familyList = document.getElementById('family-list');
        const requestList = document.getElementById('request-list');
        const familySelect = document.getElementById('family-select');

        let familyMembers = JSON.parse(localStorage.getItem('familyMembers')) || []; // localStorageから読み込み
        let requestCounter = 0; // 依頼のユニークID用
        let requests = []; // 依頼の情報を保存する配列

        // 家族リストの表示
        function renderFamilyList() {
            familyList.innerHTML = '';
            familySelect.innerHTML = ''; // ドロップダウンもクリア

            if (familyMembers.length === 0) {
                familyList.textContent = '登録された家族はいません。';
                const defaultOption = document.createElement('option');
                defaultOption.textContent = '家族がいません';
                familySelect.appendChild(defaultOption);
                familySelect.disabled = true;
            } else {
                familyMembers.forEach(member => {
                    // サイドバーのリスト
                    const li = document.createElement('li');
                    li.textContent = member.name;
                    familyList.appendChild(li);

                    // ドロップダウンのオプション
                    const option = document.createElement('option');
                    option.value = member.name;
                    option.textContent = member.name;
                    familySelect.appendChild(option);
                });
                familySelect.disabled = false;
            }
        }

        // 依頼送信処理
        submitRequestButton.addEventListener('click', () => {
            const requestText = requestInput.value.trim();
            const selectedFamilyMember = familySelect.value;

            if (requestText === '') {
                requestStatusDisplay.textContent = '依頼内容を入力してください。';
                return;
            }

            if (familyMembers.length === 0) {
                requestStatusDisplay.textContent = '先に家族を登録してください。';
                return;
            }

            requestCounter++;
            const newRequest = {
                id: requestCounter,
                text: requestText,
                status: '送信済み',
                acceptedBy: null,
                isCompleted: false,
                sentTo: selectedFamilyMember // 送信相手を記録
            };
            requests.unshift(newRequest); // 新しい依頼をリストの先頭に追加
            
            // 家族に通知するダミー処理
            requestStatusDisplay.textContent = `「${requestText}」の依頼を${selectedFamilyMember}に送信しました。`;
            console.log('依頼データ:', newRequest);

            renderRequestList();
            requestInput.value = '';
        });

        // 依頼リストの表示
        function renderRequestList() {
            requestList.innerHTML = '';
            if (requests.length === 0) {
                requestList.textContent = '依頼はありません。';
            } else {
                requests.forEach(req => {
                    const li = document.createElement('li');
                    li.classList.add('request-item');
                    li.innerHTML = `
                        <strong>依頼内容:</strong> ${req.text}<br>
                        <strong>現在の状況:</strong> ${req.status}<br>
                        ${req.acceptedBy ? `<strong>対応者:</strong> ${req.acceptedBy}` : ''}
                        <div class="kebab-menu">
                            <button class="kebab-button">&#8942;</button>
                            <div class="dropdown-menu">
                                <button class="delete-request-button" data-id="${req.id}">削除</button>
                            </div>
                        </div>
                    `;
                    requestList.appendChild(li);
                });
            }
        }

        // 依頼削除処理
        requestList.addEventListener('click', (event) => {
            if (event.target.classList.contains('kebab-button')) {
                const dropdown = event.target.nextElementSibling;
                // Close other dropdowns
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    if (menu !== dropdown) {
                        menu.classList.remove('show');
                    }
                });
                dropdown.classList.toggle('show');
            } else if (event.target.classList.contains('delete-request-button')) {
                const requestId = parseInt(event.target.dataset.id, 10);
                requests = requests.filter(req => req.id !== requestId);
                renderRequestList();
            }
        });

        // Close dropdowns if clicking outside
        window.addEventListener('click', (event) => {
            if (!event.target.matches('.kebab-button')) {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });
        
        // --- ここからWeb Speech APIの処理 ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = false;
            recognition.interimResults = false;

            startButton.addEventListener('click', () => {
                requestStatusDisplay.textContent = 'お話しください...';
                recognition.start();
            });

            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                requestInput.value = speechResult;
                requestStatusDisplay.textContent = `「${speechResult}」と聞き取りました。`;
            };

            recognition.onend = () => {
                if (requestInput.value) {
                    requestStatusDisplay.textContent = `「${requestInput.value}」と聞き取りました。`;
                }
            };

            recognition.onerror = (event) => {
                requestStatusDisplay.textContent = 'ごめんなさい、うまく聞き取れませんでした。もう一度お願いします。';
                console.error('認識エラー:', event.error);
            };
        } else {
            requestStatusDisplay.textContent = 'お使いのブラウザは音声入力に対応していません。';
            startButton.disabled = true;
        }

        // 初期表示
        renderFamilyList();
        renderRequestList();

        // 依頼状況をシミュレーションするためのダミー処理
        // 5秒後に依頼が了承されると仮定
        setInterval(() => {
            if (requests.length > 0) {
                const latestRequest = requests[0];
                if (latestRequest.status === '送信済み') {
                    latestRequest.status = '了承済み';
                    latestRequest.acceptedBy = familyMembers[0] ? familyMembers[0].name : '家族';
                    renderRequestList();
                    console.log('依頼が了承されました:', latestRequest);
                } else if (latestRequest.status === '了承済み') {
                    latestRequest.status = '完了';
                    renderRequestList();
                    console.log('依頼が完了しました:', latestRequest);
                }
            }
        }, 5000);
    </script> 
</body>
</html>